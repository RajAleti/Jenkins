pipeline {
  agent {
    docker {
      image "maven:3.9.6-eclipse-temurin-17"
      // comment out the cache first build; re-enable later if you want
      // args "-v /root/.m2:/root/.m2"
    }
  }
  options { timestamps() }
  stages {
    stage('Env') {
      steps {
        sh '''
          whoami
          uname -a || ver
          pwd
          ls -la
          echo "JAVA_HOME: $JAVA_HOME"
          java -version || true
          mvn -v || true
        '''
      }
    }
    stage('Checkout') {
      steps {
        checkout scm
        sh 'echo "After checkout:" && ls -la'
      }
    }
    stage('Build') {
      steps { sh 'mvn -B -e -X clean compile' } // verbose flags to see root cause
    }
    stage('Test') {
      steps { sh 'mvn -B -e -X test' }
    }
    stage('Package') {
      steps { sh 'mvn -B -e -X package' }
    }
  }
  post {
    success {
      archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
    }
    failure {
      sh 'echo "Workspace after failure:" && ls -R'
    }
    always {
      cleanWs()
    }
  }
}
